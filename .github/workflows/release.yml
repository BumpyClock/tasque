name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-upload:
    name: Build & Upload (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust format check
        run: cargo fmt --check

      - name: Rust lint
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Rust tests
        run: cargo test --all-targets --all-features
      
      - name: Build release binary
        run: cargo build --release --locked

      - name: Package artifact (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(grep '^version = ' Cargo.toml | head -n1 | cut -d'\"' -f2)"
          OS="$(uname | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m)"
          mkdir -p dist/releases
          BIN="target/release/tsq"
          OUT="dist/releases/tsq-v${VERSION}-${OS}-${ARCH}"
          cp "${BIN}" "${OUT}"
          chmod +x "${OUT}"
          shasum -a 256 "${OUT}" > dist/releases/SHA256SUMS.txt

      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $versionLine = Get-Content Cargo.toml | Where-Object { $_ -match '^version = ' } | Select-Object -First 1
          $version = $versionLine -replace '^version = \"([^\"]+)\"$', '$1'
          $arch = $env:PROCESSOR_ARCHITECTURE.ToLower()
          New-Item -ItemType Directory -Force dist/releases | Out-Null
          $bin = 'target/release/tsq.exe'
          $out = \"dist/releases/tsq-v$version-windows-$arch.exe\"
          Copy-Item $bin $out -Force
          $hash = Get-FileHash $out -Algorithm SHA256
          \"{0}  {1}\" -f $hash.Hash.ToLower(), (Split-Path $out -Leaf) | Set-Content dist/releases/SHA256SUMS.txt

      - name: Upload release artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: dist/releases/*
