name: Release From Cargo

on:
  workflow_dispatch:
    inputs:
      version:
        description: Optional explicit version; must match Cargo.toml when provided
        required: false
        type: string
      target:
        description: Target branch or commit SHA for the tag
        required: false
        default: main
        type: string

permissions:
  contents: write

jobs:
  rust-quality:
    name: Rust Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - run: cargo fmt --check
      - run: cargo clippy --all-targets --all-features -- -D warnings
      - run: cargo test --quiet

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: rust-quality
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve version from Cargo.toml
        id: version
        env:
          EXPECTED_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          VERSION="$(grep '^version = ' Cargo.toml | head -n1 | cut -d'\"' -f2)"
          if [ -n "${EXPECTED_VERSION}" ]; then
            if [ "${EXPECTED_VERSION}" != "${VERSION}" ]; then
              echo "provided version ${EXPECTED_VERSION} does not match Cargo.toml version ${VERSION}"
              exit 1
            fi
          fi
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=v${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Ensure release tag does not already exist
        run: |
          set -euo pipefail
          git fetch --tags --force
          TAG="${{ steps.version.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists."
            exit 1
          fi

      - name: Create GitHub release from Cargo version
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ inputs.target }}
          generate_release_notes: true
